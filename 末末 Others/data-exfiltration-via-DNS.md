# Data Exfiltration
Data Exfiltration on port 53

## Setup
![Screenshot_2021-05-01_18-19-45](https://user-images.githubusercontent.com/39619599/116796521-172eba80-aaab-11eb-9a8e-122dd7b59ee8.png)

The Windows workstation is not connected to the internet.

nmap result: 
```
PORT     STATE SERVICE            VERSION
3389/tcp open  ssl/ms-wbt-server    ?
```

The goal is to exfiltrate some data from the Windows host, but we don't know which destination ports are whitelisted for outbound connectivity. 

### Task 1: Connect and Identify Subjects to Exfiltrate

```
# RDP connection
rdesktop 172.16.91.100
```

```
# search file systems for sensitive files to exfiltrate
# first go to the root directory
dir /
dir /s /b passwords*
dir /s /b credentials*
```
* /s - Goes thru the subdirectories as well
* /b - Displays a bare list of directories and files, with no additional information. 

![1](https://user-images.githubusercontent.com/39619599/116796517-1007ac80-aaab-11eb-9b93-52f923b94b76.png)

Additionally, discovered that Python is installed on the victim `Python --version`

### Task 2: Identify dest. ports allowed for outbound connectivity
Let's check ports 80 (TCP), 443 (TCP), 8080 (TCP), 8443 (TCP), and 53 (UDP)
* Have we had the internet connection on victim, we can use `portquiz.net` ([see this post](https://superuser.com/a/1336056)):
    ```
    # check all ports
    time nmap -p- portquiz.net | grep -i open
    ```

So our options here are 
1. Directly check the Windwos firewall config; or
2. Use the [egress framework](https://github.com/stufus/egresscheck-framework) to check all portsl or
3. Check TCP ports with Python SimpleHTTPServer. Deploy a Python SimpleHTTPServer on various ports on Kali and check if we can establish connection from the victim's browser. Once a working port is found, we can even use this to pass files to victim. 
    ```
    python -m SimpleHTTPServer 8080
    ```
For port 53 (DNS)
* If we are on a real switched network with the target, we can simply sniff in promiscuous mode for any DNS requests originating from the victim. 
* However, due to the virtualization of the lab, this is not possible. The work around is to modify the DNS config on the victim to use Kali as the DNS server, and try to open any webpage to see we sniff any DNS packet. 

    On Windows, go Ethernet0 -> Properties -> Internet Protocol Version 4 -> Properties

    <img src="https://user-images.githubusercontent.com/39619599/116796838-aa68ef80-aaad-11eb-9940-d6b91b09967e.png" width=40%>

### Task 3: Exfiltrate a file in DNS packets with PacketWhisper

Need PacketWhisper on both Kali and victim

On Kali

```
git clone https://github.com/TryCatchHCF/PacketWhisper.git
```

For victim, pass the zipped version over via the web server
```
# download as zip file
wget https://github.com/TryCatchHCF/PacketWhisper/archive/master.zip
```
See lab notes for more details
